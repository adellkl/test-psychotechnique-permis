====================================
SYSTÈME DE RAPPELS 3H AVANT LE RDV
====================================

DESCRIPTION :
-------------
Système automatique d'envoi d'emails de rappel aux candidats 3 heures avant leur rendez-vous.
Les rappels sont envoyés automatiquement toutes les heures via un cron job Vercel.

FICHIERS CRÉÉS :
----------------
1. /app/api/reminders/send-3h-before/route.ts
   - API endpoint pour envoyer les rappels
   - Recherche les rendez-vous confirmés dans les 3 prochaines heures
   - Envoie un email via sendAppointmentReminder()
   - Marque les rappels comme envoyés dans la base de données

2. /vercel.json (modifié)
   - Configuration du cron job
   - Schedule: "0 * * * *" (toutes les heures, à la minute 0)

3. add-reminder-3h-columns.txt
   - Script SQL pour ajouter les colonnes nécessaires

COLONNES AJOUTÉES À LA TABLE APPOINTMENTS :
-------------------------------------------
- reminder_3h_sent (BOOLEAN) : Indique si le rappel 3h a été envoyé
- reminder_3h_sent_at (TIMESTAMP) : Date et heure d'envoi du rappel

CONFIGURATION REQUISE :
-----------------------
1. Exécuter le script SQL dans Supabase (add-reminder-3h-columns.txt)

2. Ajouter dans .env.local :
   CRON_SECRET=votre-secret-securise-ici
   
3. Le cron job Vercel appellera automatiquement :
   https://test-psychotechnique-permis.com/api/reminders/send-3h-before
   Avec l'header: Authorization: Bearer CRON_SECRET

FONCTIONNEMENT :
----------------
1. Le cron job s'exécute toutes les heures (à :00)
2. L'API recherche les rendez-vous confirmés entre 2h45 et 3h dans le futur
3. Pour chaque rendez-vous trouvé :
   - Vérifie que reminder_3h_sent = false
   - Envoie l'email de rappel
   - Marque reminder_3h_sent = true
   - Enregistre reminder_3h_sent_at

EXEMPLE DE TIMELINE :
---------------------
RDV prévu à 15:00
├─ 12:00 - Cron s'exécute, RDV trop loin
├─ 13:00 - Cron s'exécute, RDV trop loin (pas dans la fenêtre 2h45-3h)
├─ 12:00 - Cron s'exécute, RDV dans la fenêtre → Email envoyé ✅
├─ 13:00 - Cron s'exécute, mais reminder_3h_sent = true → Ignoré
└─ 15:00 - Rendez-vous

LOGS ET MONITORING :
--------------------
Les logs sont affichés dans la console Vercel :
- ✅ [REMINDER-3H] Rappel envoyé à email@example.com
- ❌ [REMINDER-3H] Erreur envoi rappel
- ℹ️  [REMINDER-3H] Aucun rendez-vous à rappeler

SÉCURITÉ :
----------
L'endpoint est protégé par un secret (CRON_SECRET) pour empêcher les appels non autorisés.
Seul le cron job Vercel peut appeler cet endpoint.

TEST MANUEL :
-------------
Pour tester manuellement, faire une requête GET ou POST à :
https://test-psychotechnique-permis.com/api/reminders/send-3h-before

Avec l'header :
Authorization: Bearer VOTRE_CRON_SECRET

TEMPLATE EMAIL UTILISÉ :
------------------------
Le système utilise le template "appointment_reminder_client" existant dans la base de données.
Ce template est déjà configuré avec les variables nécessaires.

MAINTENANCE :
-------------
- Vérifier régulièrement les logs Vercel pour s'assurer du bon fonctionnement
- Surveiller que les emails sont bien envoyés
- En cas d'erreur d'envoi, le système continuera d'essayer à la prochaine exécution
  (tant que reminder_3h_sent = false)
